<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Epson TM-30MIII-H Produktionstest</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, button, select, textarea {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        input, select, textarea {
            width: 100%;
            box-sizing: border-box;
        }
        button {
            background-color: #007cba;
            color: white;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background-color: #005a87;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .warning { background-color: #fff3cd; color: #856404; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .method-info {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .critical {
            background: #ffebee;
            border: 2px solid #f44336;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .test-section {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-online { background-color: #28a745; }
        .status-offline { background-color: #dc3545; }
        .status-unknown { background-color: #ffc107; }
        .printer-info {
            background: #f8f9fa;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 10px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üñ®Ô∏è Epson TM-30MIII-H Produktionstest</h1>
        
        <div class="critical">
            <h3>‚ö†Ô∏è Viktig Information</h3>
            <p><strong>Produktionsmilj√∂:</strong> Du anv√§nder HTTPS (moisushi.se) vilket kr√§ver SSL-certifikat p√• skrivaren.</p>
            <p><strong>Mixed Content:</strong> HTTP-anrop till skrivaren blockeras av webbl√§saren i HTTPS-milj√∂.</p>
            <p><strong>L√∂sning:</strong> Skrivaren m√•ste ha SSL-certifikat och anv√§nda HTTPS port 443.</p>
        </div>
        
        <div class="form-group">
            <label for="printerIP">Skrivare IP-adress:</label>
            <input type="text" id="printerIP" value="192.168.1.103" placeholder="t.ex. 192.168.1.103">
        </div>
        
        <div class="form-group">
            <label for="useSSL">Anv√§nd SSL (HTTPS):</label>
            <select id="useSSL">
                <option value="true">Ja (Port 443) - Rekommenderat f√∂r produktion</option>
                <option value="false">Nej (Port 80) - Endast f√∂r lokala tester</option>
            </select>
        </div>
    </div>

    <div class="grid">
        <div class="container">
            <h2>üîç N√§tverksdiagnostik</h2>
            
            <div class="test-section">
                <h3>1. Ping Test</h3>
                <button onclick="testPing()">Testa Ping</button>
                <div id="pingStatus"></div>
            </div>
            
            <div class="test-section">
                <h3>2. Port Scan</h3>
                <button onclick="testPorts()">Scanna Portar</button>
                <div id="portStatus"></div>
            </div>
            
            <div class="test-section">
                <h3>3. SSL Certificate</h3>
                <button onclick="testSSLCertificate()">Testa SSL</button>
                <div id="sslStatus"></div>
            </div>
            
            <div class="test-section">
                <h3>4. N√§tverkslatency</h3>
                <button onclick="testLatency()">Testa Latency</button>
                <div id="latencyStatus"></div>
            </div>
        </div>
        
        <div class="container">
            <h2>üñ®Ô∏è Skrivardiagnostik</h2>
            
            <div class="test-section">
                <h3>1. ePOS SDK Anslutning</h3>
                <button onclick="testEPOSConnection()">Testa ePOS</button>
                <div id="eposStatus"></div>
            </div>
            
            <div class="test-section">
                <h3>2. Skrivarstatus</h3>
                <button onclick="getPrinterStatus()">H√§mta Status</button>
                <div id="printerStatusDisplay"></div>
            </div>
            
            <div class="test-section">
                <h3>3. Skrivardiscovery</h3>
                <button onclick="discoverPrinters()">S√∂k Skrivare</button>
                <div id="discoveryStatus"></div>
            </div>
            
            <div class="test-section">
                <h3>4. Test Print</h3>
                <button onclick="testPrint()">Skriv ut Test</button>
                <div id="printStatus"></div>
            </div>
        </div>
    </div>

    <div class="container">
        <h2>üîß Avancerade Tester</h2>
        
        <div class="grid">
            <div class="test-section">
                <h3>Backend API Test</h3>
                <button onclick="testBackendAPI()">Testa Backend</button>
                <div id="backendStatus"></div>
            </div>
            
            <div class="test-section">
                <h3>XML Print Test</h3>
                <button onclick="testXMLPrint()">Testa XML Print</button>
                <div id="xmlStatus"></div>
            </div>
            
            <div class="test-section">
                <h3>WebSocket Test</h3>
                <button onclick="testWebSocket()">Testa WebSocket</button>
                <div id="wsStatus"></div>
            </div>
            
            <div class="test-section">
                <h3>CORS Test</h3>
                <button onclick="testCORS()">Testa CORS</button>
                <div id="corsStatus"></div>
            </div>
        </div>
    </div>

    <div class="container">
        <h2>üìä Resultat</h2>
        <div id="overallStatus"></div>
        <div id="log" class="log"></div>
        <button onclick="clearLog()">Rensa Logg</button>
        <button onclick="exportResults()">Exportera Resultat</button>
    </div>

    <script src="https://192.168.1.103/js/epos-print-4.0.0.js"></script>
    
    <script>
        // Global variables
        let eposDevice = null;
        let testResults = {};
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('sv-SE');
            const logElement = document.getElementById('log');
            const colorMap = {
                'info': '#333',
                'success': '#28a745',
                'error': '#dc3545',
                'warning': '#ffc107'
            };
            
            const logEntry = `<div style="color: ${colorMap[type]}">[${timestamp}] ${message}</div>`;
            logElement.innerHTML += logEntry;
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(`[${timestamp}] ${message}`);
        }
        
        function showStatus(elementId, message, type, details = null) {
            const element = document.getElementById(elementId);
            const statusClass = type === 'success' ? 'success' : 
                              type === 'error' ? 'error' : 
                              type === 'warning' ? 'warning' : 'info';
            
            const statusIcon = type === 'success' ? '‚úÖ' : 
                              type === 'error' ? '‚ùå' : 
                              type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            
            element.innerHTML = `
                <div class="status ${statusClass}">
                    ${statusIcon} ${message}
                    ${details ? `<div class="printer-info">${details}</div>` : ''}
                </div>
            `;
            
            // Store result for export
            testResults[elementId] = { message, type, details, timestamp: new Date().toISOString() };
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
            testResults = {};
        }
        
        // 1. Ping Test
        async function testPing() {
            const ip = document.getElementById('printerIP').value;
            log(`üèì Testar ping till ${ip}...`, 'info');
            
            const startTime = performance.now();
            
            try {
                // Test using fetch with timeout
                const response = await fetch(`https://${ip}/`, {
                    method: 'HEAD',
                    mode: 'no-cors',
                    signal: AbortSignal.timeout(5000)
                });
                
                const endTime = performance.now();
                const latency = Math.round(endTime - startTime);
                
                log(`‚úÖ Ping framg√•ngsrik: ${latency}ms`, 'success');
                showStatus('pingStatus', `Ping framg√•ngsrik (${latency}ms)`, 'success');
            } catch (error) {
                const endTime = performance.now();
                const latency = Math.round(endTime - startTime);
                
                log(`‚ùå Ping misslyckades: ${error.message}`, 'error');
                showStatus('pingStatus', `Ping misslyckades (${latency}ms)`, 'error', error.message);
            }
        }
        
        // 2. Port Scan
        async function testPorts() {
            const ip = document.getElementById('printerIP').value;
            const ports = [80, 443, 9100, 8080, 3001];
            
            log(`üîç Scannar portar p√• ${ip}...`, 'info');
            
            const portResults = [];
            
            for (const port of ports) {
                try {
                    const startTime = performance.now();
                    
                    // Test WebSocket connection (most reliable for port testing)
                    const wsPromise = new Promise((resolve, reject) => {
                        const ws = new WebSocket(`ws://${ip}:${port}/`);
                        const timeout = setTimeout(() => {
                            ws.close();
                            reject(new Error('timeout'));
                        }, 3000);
                        
                        ws.onopen = () => {
                            clearTimeout(timeout);
                            ws.close();
                            resolve('open');
                        };
                        
                        ws.onerror = () => {
                            clearTimeout(timeout);
                            reject(new Error('connection_refused'));
                        };
                    });
                    
                    await wsPromise;
                    const endTime = performance.now();
                    const latency = Math.round(endTime - startTime);
                    
                    portResults.push(`Port ${port}: ‚úÖ √ñppen (${latency}ms)`);
                    log(`‚úÖ Port ${port} √§r √∂ppen`, 'success');
                } catch (error) {
                    const endTime = performance.now();
                    const latency = Math.round(endTime - startTime);
                    
                    portResults.push(`Port ${port}: ‚ùå St√§ngd (${latency}ms)`);
                    log(`‚ùå Port ${port} √§r st√§ngd eller otillg√§nglig`, 'error');
                }
            }
            
            showStatus('portStatus', 'Port scan komplett', 'info', portResults.join('\n'));
        }
        
        // 3. SSL Certificate Test
        async function testSSLCertificate() {
            const ip = document.getElementById('printerIP').value;
            log(`üîí Testar SSL-certifikat p√• ${ip}...`, 'info');
            
            try {
                const response = await fetch(`https://${ip}/`, {
                    method: 'HEAD',
                    signal: AbortSignal.timeout(10000)
                });
                
                log(`‚úÖ SSL-certifikat giltigt`, 'success');
                showStatus('sslStatus', 'SSL-certifikat giltigt', 'success', `Status: ${response.status}`);
            } catch (error) {
                log(`‚ùå SSL-certifikat problem: ${error.message}`, 'error');
                showStatus('sslStatus', 'SSL-certifikat problem', 'error', error.message);
            }
        }
        
        // 4. Latency Test
        async function testLatency() {
            const ip = document.getElementById('printerIP').value;
            log(`‚ö° Testar latency till ${ip}...`, 'info');
            
            const latencies = [];
            
            for (let i = 0; i < 5; i++) {
                try {
                    const startTime = performance.now();
                    
                    await fetch(`https://${ip}/`, {
                        method: 'HEAD',
                        mode: 'no-cors',
                        signal: AbortSignal.timeout(3000)
                    });
                    
                    const endTime = performance.now();
                    const latency = Math.round(endTime - startTime);
                    latencies.push(latency);
                    
                    log(`Test ${i + 1}: ${latency}ms`, 'info');
                } catch (error) {
                    log(`Test ${i + 1}: Timeout`, 'warning');
                }
            }
            
            if (latencies.length > 0) {
                const avgLatency = Math.round(latencies.reduce((a, b) => a + b, 0) / latencies.length);
                const minLatency = Math.min(...latencies);
                const maxLatency = Math.max(...latencies);
                
                log(`‚úÖ Genomsnittlig latency: ${avgLatency}ms`, 'success');
                showStatus('latencyStatus', `Latency test komplett`, 'success', 
                    `Genomsnitt: ${avgLatency}ms\nMin: ${minLatency}ms\nMax: ${maxLatency}ms`);
            } else {
                log(`‚ùå Alla latency-tester misslyckades`, 'error');
                showStatus('latencyStatus', 'Latency test misslyckades', 'error');
            }
        }
        
        // 5. ePOS SDK Connection Test
        async function testEPOSConnection() {
            const ip = document.getElementById('printerIP').value;
            const useSSL = document.getElementById('useSSL').value === 'true';
            
            log(`üîå Testar ePOS SDK-anslutning till ${ip}...`, 'info');
            
            try {
                // Check if ePOS is available
                if (typeof epos === 'undefined') {
                    throw new Error('ePOS SDK √§r inte laddat');
                }
                
                // Create ePOS Device
                const protocol = useSSL ? 'https' : 'http';
                const port = useSSL ? 443 : 80;
                const url = `${protocol}://${ip}:${port}/`;
                
                eposDevice = new epos.ePOSDevice();
                
                // Test connection
                eposDevice.connect(url, (data) => {
                    if (data === 'OK') {
                        log(`‚úÖ ePOS SDK anslutning framg√•ngsrik`, 'success');
                        showStatus('eposStatus', 'ePOS SDK anslutning framg√•ngsrik', 'success', `URL: ${url}`);
                    } else {
                        log(`‚ùå ePOS SDK anslutning misslyckades: ${data}`, 'error');
                        showStatus('eposStatus', 'ePOS SDK anslutning misslyckades', 'error', data);
                    }
                });
                
            } catch (error) {
                log(`‚ùå ePOS SDK fel: ${error.message}`, 'error');
                showStatus('eposStatus', 'ePOS SDK fel', 'error', error.message);
            }
        }
        
        // 6. Get Printer Status
        async function getPrinterStatus() {
            const ip = document.getElementById('printerIP').value;
            
            log(`üìã H√§mtar skrivarstatus fr√•n ${ip}...`, 'info');
            
            if (!eposDevice) {
                log(`‚ùå ePOS-enhet inte ansluten`, 'error');
                showStatus('printerStatusDisplay', 'ePOS-enhet inte ansluten', 'error');
                return;
            }
            
            try {
                eposDevice.createDevice('local_printer', epos.DEVICE_TYPE_PRINTER, {
                    'crypto': false,
                    'buffer': false
                }, (deviceObj, retCode) => {
                    if (retCode === 'OK') {
                        deviceObj.getStatus((status) => {
                            log(`‚úÖ Skrivarstatus h√§mtad`, 'success');
                            showStatus('printerStatusDisplay', 'Skrivarstatus', 'success', 
                                `Status: ${JSON.stringify(status, null, 2)}`);
                        });
                    } else {
                        log(`‚ùå Kunde inte skapa skrivarobjekt: ${retCode}`, 'error');
                        showStatus('printerStatusDisplay', 'Kunde inte skapa skrivarobjekt', 'error', retCode);
                    }
                });
            } catch (error) {
                log(`‚ùå Fel vid statusf√∂rfr√•gan: ${error.message}`, 'error');
                showStatus('printerStatusDisplay', 'Fel vid statusf√∂rfr√•gan', 'error', error.message);
            }
        }
        
        // 7. Discover Printers
        async function discoverPrinters() {
            log(`üîç S√∂ker efter skrivare i n√§tverket...`, 'info');
            
            try {
                if (typeof epos === 'undefined') {
                    throw new Error('ePOS SDK √§r inte laddat');
                }
                
                epos.ePOSDeviceService.discover({
                    deviceType: epos.DEVICE_TYPE_PRINTER,
                    usingBonjour: true
                }, (deviceList) => {
                    if (deviceList.length > 0) {
                        log(`‚úÖ Hittade ${deviceList.length} skrivare`, 'success');
                        const deviceInfo = deviceList.map(device => 
                            `${device.deviceName} (${device.target})`
                        ).join('\n');
                        showStatus('discoveryStatus', `Hittade ${deviceList.length} skrivare`, 'success', deviceInfo);
                    } else {
                        log(`‚ö†Ô∏è Inga skrivare hittades`, 'warning');
                        showStatus('discoveryStatus', 'Inga skrivare hittades', 'warning');
                    }
                });
            } catch (error) {
                log(`‚ùå Discovery fel: ${error.message}`, 'error');
                showStatus('discoveryStatus', 'Discovery fel', 'error', error.message);
            }
        }
        
        // 8. Test Print
        async function testPrint() {
            const ip = document.getElementById('printerIP').value;
            
            log(`üñ®Ô∏è Skickar test-utskrift till ${ip}...`, 'info');
            
            if (!eposDevice) {
                log(`‚ùå ePOS-enhet inte ansluten`, 'error');
                showStatus('printStatus', 'ePOS-enhet inte ansluten', 'error');
                return;
            }
            
            try {
                eposDevice.createDevice('local_printer', epos.DEVICE_TYPE_PRINTER, {
                    'crypto': false,
                    'buffer': false
                }, (deviceObj, retCode) => {
                    if (retCode === 'OK') {
                        // Create print data
                        deviceObj.addText('MOI SUSHI TEST\n');
                        deviceObj.addText('================\n');
                        deviceObj.addText('Datum: ' + new Date().toLocaleDateString('sv-SE') + '\n');
                        deviceObj.addText('Tid: ' + new Date().toLocaleTimeString('sv-SE') + '\n');
                        deviceObj.addText('IP: ' + ip + '\n');
                        deviceObj.addText('================\n');
                        deviceObj.addText('Test framg√•ngsrik!\n');
                        deviceObj.addCut(epos.CUT_FEED);
                        
                        // Send print job
                        deviceObj.send();
                        
                        log(`‚úÖ Test-utskrift skickad`, 'success');
                        showStatus('printStatus', 'Test-utskrift skickad', 'success');
                    } else {
                        log(`‚ùå Kunde inte skapa skrivarobjekt: ${retCode}`, 'error');
                        showStatus('printStatus', 'Kunde inte skapa skrivarobjekt', 'error', retCode);
                    }
                });
            } catch (error) {
                log(`‚ùå Utskriftsfel: ${error.message}`, 'error');
                showStatus('printStatus', 'Utskriftsfel', 'error', error.message);
            }
        }
        
        // 9. Backend API Test
        async function testBackendAPI() {
            const ip = document.getElementById('printerIP').value;
            
            log(`üîß Testar backend API...`, 'info');
            
            try {
                const response = await fetch('/api/printer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'test',
                        printerIP: ip,
                        useSSL: document.getElementById('useSSL').value === 'true'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    log(`‚úÖ Backend API test framg√•ngsrik`, 'success');
                    showStatus('backendStatus', 'Backend API test framg√•ngsrik', 'success', result.message);
                } else {
                    log(`‚ùå Backend API test misslyckades: ${result.error}`, 'error');
                    showStatus('backendStatus', 'Backend API test misslyckades', 'error', result.error);
                }
            } catch (error) {
                log(`‚ùå Backend API fel: ${error.message}`, 'error');
                showStatus('backendStatus', 'Backend API fel', 'error', error.message);
            }
        }
        
        // 10. XML Print Test
        async function testXMLPrint() {
            const ip = document.getElementById('printerIP').value;
            
            log(`üìÑ Testar XML-utskrift...`, 'info');
            
            const testXML = `<?xml version="1.0" encoding="UTF-8"?>
<s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/">
    <s:Body>
        <epos-print xmlns="http://www.epson.com/2005/02/printing/epos-print">
            <text>MOI SUSHI XML TEST</text>
            <text>==================</text>
            <text>Datum: ${new Date().toLocaleDateString('sv-SE')}</text>
            <text>Tid: ${new Date().toLocaleTimeString('sv-SE')}</text>
            <text>IP: ${ip}</text>
            <text>==================</text>
            <text>XML Test framg√•ngsrik!</text>
            <cut type="feed"/>
        </epos-print>
    </s:Body>
</s:Envelope>`;
            
            try {
                const response = await fetch('/api/printer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'print_xml',
                        xml: testXML,
                        printerIP: ip,
                        useSSL: document.getElementById('useSSL').value === 'true'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    log(`‚úÖ XML-utskrift framg√•ngsrik`, 'success');
                    showStatus('xmlStatus', 'XML-utskrift framg√•ngsrik', 'success', result.response);
                } else {
                    log(`‚ùå XML-utskrift misslyckades: ${result.error}`, 'error');
                    showStatus('xmlStatus', 'XML-utskrift misslyckades', 'error', result.error);
                }
            } catch (error) {
                log(`‚ùå XML-utskrift fel: ${error.message}`, 'error');
                showStatus('xmlStatus', 'XML-utskrift fel', 'error', error.message);
            }
        }
        
        // 11. WebSocket Test
        async function testWebSocket() {
            const ip = document.getElementById('printerIP').value;
            
            log(`üîå Testar WebSocket-anslutning...`, 'info');
            
            try {
                const ws = new WebSocket(`ws://${ip}:80/`);
                
                ws.onopen = () => {
                    log(`‚úÖ WebSocket-anslutning framg√•ngsrik`, 'success');
                    showStatus('wsStatus', 'WebSocket-anslutning framg√•ngsrik', 'success');
                    ws.close();
                };
                
                ws.onerror = (error) => {
                    log(`‚ùå WebSocket-anslutning misslyckades`, 'error');
                    showStatus('wsStatus', 'WebSocket-anslutning misslyckades', 'error', error.message);
                };
                
                ws.onclose = (event) => {
                    if (event.code !== 1000) {
                        log(`‚ö†Ô∏è WebSocket st√§ngd ov√§ntat: ${event.code}`, 'warning');
                    }
                };
                
                // Timeout efter 5 sekunder
                setTimeout(() => {
                    if (ws.readyState === WebSocket.CONNECTING) {
                        ws.close();
                        log(`‚ùå WebSocket timeout`, 'error');
                        showStatus('wsStatus', 'WebSocket timeout', 'error');
                    }
                }, 5000);
                
            } catch (error) {
                log(`‚ùå WebSocket fel: ${error.message}`, 'error');
                showStatus('wsStatus', 'WebSocket fel', 'error', error.message);
            }
        }
        
        // 12. CORS Test
        async function testCORS() {
            const ip = document.getElementById('printerIP').value;
            
            log(`üåê Testar CORS-konfiguration...`, 'info');
            
            try {
                const response = await fetch(`https://${ip}/`, {
                    method: 'OPTIONS',
                    headers: {
                        'Origin': window.location.origin,
                        'Access-Control-Request-Method': 'POST',
                        'Access-Control-Request-Headers': 'Content-Type'
                    }
                });
                
                const corsHeaders = {
                    'Access-Control-Allow-Origin': response.headers.get('Access-Control-Allow-Origin'),
                    'Access-Control-Allow-Methods': response.headers.get('Access-Control-Allow-Methods'),
                    'Access-Control-Allow-Headers': response.headers.get('Access-Control-Allow-Headers')
                };
                
                log(`‚úÖ CORS-konfiguration h√§mtad`, 'success');
                showStatus('corsStatus', 'CORS-konfiguration', 'success', 
                    Object.entries(corsHeaders).map(([key, value]) => `${key}: ${value || 'Ej satt'}`).join('\n'));
                
            } catch (error) {
                log(`‚ùå CORS-test misslyckades: ${error.message}`, 'error');
                showStatus('corsStatus', 'CORS-test misslyckades', 'error', error.message);
            }
        }
        
        // Export Results
        function exportResults() {
            const results = {
                timestamp: new Date().toISOString(),
                printerIP: document.getElementById('printerIP').value,
                useSSL: document.getElementById('useSSL').value === 'true',
                userAgent: navigator.userAgent,
                testResults: testResults
            };
            
            const dataStr = JSON.stringify(results, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `epson-test-results-${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            log(`‚úÖ Testresultat exporterade`, 'success');
        }
        
        // Run comprehensive test
        async function runComprehensiveTest() {
            log(`üöÄ Startar omfattande test...`, 'info');
            
            await testPing();
            await new Promise(resolve => setTimeout(resolve, 1000));
            await testPorts();
            await new Promise(resolve => setTimeout(resolve, 1000));
            await testSSLCertificate();
            await new Promise(resolve => setTimeout(resolve, 1000));
            await testLatency();
            await new Promise(resolve => setTimeout(resolve, 1000));
            await testEPOSConnection();
            await new Promise(resolve => setTimeout(resolve, 2000));
            await getPrinterStatus();
            await new Promise(resolve => setTimeout(resolve, 1000));
            await testBackendAPI();
            
            log(`‚úÖ Omfattande test komplett`, 'success');
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            log(`üñ®Ô∏è Epson TM-30MIII-H Test initialiserad`, 'info');
            log(`üåç Milj√∂: ${window.location.protocol}//${window.location.hostname}`, 'info');
            log(`üì± User Agent: ${navigator.userAgent}`, 'info');
            
            // Add comprehensive test button
            const container = document.querySelector('.container');
            const comprehensiveBtn = document.createElement('button');
            comprehensiveBtn.textContent = 'K√∂r Omfattande Test';
            comprehensiveBtn.onclick = runComprehensiveTest;
            comprehensiveBtn.style.marginBottom = '20px';
            comprehensiveBtn.style.backgroundColor = '#28a745';
            container.appendChild(comprehensiveBtn);
        });
    </script>
</body>
</html> 