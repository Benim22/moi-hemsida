<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Epson TM-T20III Test - Backend TCP</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, button, select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        input, select {
            width: 200px;
        }
        button {
            background-color: #007cba;
            color: white;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #005a87;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .warning { background-color: #fff3cd; color: #856404; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin-top: 20px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .method-info {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üñ®Ô∏è Epson TM-T20III Test</h1>
        
        <div class="method-info">
            <h3>üì° Backend API-metod (Rekommenderad f√∂r produktion)</h3>
            <p>Denna testsida anv√§nder <strong>Backend API</strong> f√∂r att ansluta till skrivaren.</p>
            <p><strong>F√∂rdelar:</strong> Mer tillf√∂rlitlig, fungerar i alla webbl√§sare, inga CORS-problem.</p>
            <p><strong>SSL-st√∂d:</strong> Fungerar b√•de med HTTP (port 80) och HTTPS (port 443).</p>
        </div>
        
        <div class="form-group">
            <label for="printerIP">Skrivare IP-adress:</label>
            <input type="text" id="printerIP" value="192.168.1.103" placeholder="t.ex. 192.168.1.103">
        </div>
        
        <div class="form-group">
            <label for="useSSL">Anv√§nd SSL (HTTPS):</label>
            <select id="useSSL">
                <option value="true">Ja (Port 443) - F√∂r produktionsmilj√∂</option>
                <option value="false">Nej (Port 9100) - F√∂r lokala tester</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="testMethod">Testmetod:</label>
            <select id="testMethod">
                <option value="connection">Testa anslutning</option>
                <option value="print">Skriv ut test-kvitto</option>
                <option value="xml">Testa XML-utskrift</option>
                <option value="ssl">Testa SSL-certifikat</option>
            </select>
        </div>
        
        <div class="form-group">
            <button onclick="testPrinter()" id="testBtn">K√∂r test</button>
            <button onclick="discoverPrinters()" id="discoverBtn">S√∂k skrivare</button>
            <button onclick="clearLog()">Rensa logg</button>
        </div>
        
        <div id="status"></div>
        
        <div id="log" class="log"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('sv-SE');
            const logElement = document.getElementById('log');
            const colorMap = {
                'info': '#333',
                'success': '#28a745',
                'error': '#dc3545',
                'warning': '#ffc107'
            };
            
            logElement.innerHTML += `<div style="color: ${colorMap[type]}">[${timestamp}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(`[${timestamp}] ${message}`);
        }
        
        function showStatus(message, type) {
            const statusElement = document.getElementById('status');
            statusElement.className = `status ${type}`;
            statusElement.textContent = message;
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
            document.getElementById('status').innerHTML = '';
        }
        
        async function testPrinter() {
            const ip = document.getElementById('printerIP').value;
            const method = document.getElementById('testMethod').value;
            const testBtn = document.getElementById('testBtn');
            
            if (!ip) {
                log('‚ùå Ange en IP-adress f√∂rst', 'error');
                showStatus('Ange en IP-adress', 'error');
                return;
            }
            
            testBtn.disabled = true;
            testBtn.textContent = 'Testar...';
            
            try {
                if (method === 'connection') {
                    await testConnection(ip);
                } else if (method === 'print') {
                    await testPrint(ip);
                } else if (method === 'xml') {
                    await testXMLPrint(ip);
                } else if (method === 'ssl') {
                    await testSSLCertificate(ip);
                }
            } catch (error) {
                log(`‚ùå Ov√§ntat fel: ${error.message}`, 'error');
                showStatus(`Fel: ${error.message}`, 'error');
            } finally {
                testBtn.disabled = false;
                testBtn.textContent = 'K√∂r test';
            }
        }
        
        async function testConnection(ip) {
            const useSSL = document.getElementById('useSSL').value === 'true';
            const port = useSSL ? 443 : 9100;
            const protocol = useSSL ? 'HTTPS' : 'TCP';
            
            log(`üîó Testar ${protocol}-anslutning till ${ip}:${port}...`, 'info');
            showStatus('Testar anslutning...', 'info');
            
            try {
                const response = await fetch('/api/printer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'test',
                        printerIP: ip,
                        printerPort: port,
                        useSSL: useSSL
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    log(`‚úÖ ${protocol}-anslutning framg√•ngsrik!`, 'success');
                    showStatus(`${protocol}-anslutning framg√•ngsrik`, 'success');
                    if (result.message) {
                        log(`üìÑ ${result.message}`, 'info');
                    }
                } else {
                    log(`‚ùå ${protocol}-anslutningsfel: ${result.error}`, 'error');
                    showStatus(`${protocol}-anslutningsfel: ${result.error}`, 'error');
                }
            } catch (error) {
                log(`‚ùå N√§tverksfel: ${error.message}`, 'error');
                showStatus(`N√§tverksfel: ${error.message}`, 'error');
            }
        }
        
        async function testPrint(ip) {
            const useSSL = document.getElementById('useSSL').value === 'true';
            const port = useSSL ? 443 : 9100;
            const protocol = useSSL ? 'HTTPS' : 'TCP';
            
            log(`üñ®Ô∏è Skriver ut test-kvitto till ${ip}:${port} (${protocol})...`, 'info');
            showStatus('Skriver ut test-kvitto...', 'info');
            
            const testOrder = {
                order_number: 'TEST-001',
                created_at: new Date().toISOString(),
                customer_name: 'Test Kund',
                phone: '070-123 45 67',
                cart_items: [
                    { name: 'Test Sushi', quantity: 2, price: 89 },
                    { name: 'Test Pok√©bowl', quantity: 1, price: 129 }
                ],
                total_amount: 307
            };
            
            try {
                const response = await fetch('/api/printer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'print',
                        printerIP: ip,
                        printerPort: port,
                        order: testOrder,
                        useSSL: useSSL
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    log(`‚úÖ Test-kvitto skickat till skrivaren via ${protocol}!`, 'success');
                    showStatus(`Test-kvitto utskrivet (${protocol})`, 'success');
                    if (result.message) {
                        log(`üìÑ ${result.message}`, 'info');
                    }
                } else {
                    log(`‚ùå ${protocol}-utskriftsfel: ${result.error}`, 'error');
                    showStatus(`${protocol}-utskriftsfel: ${result.error}`, 'error');
                }
            } catch (error) {
                log(`‚ùå N√§tverksfel: ${error.message}`, 'error');
                showStatus(`N√§tverksfel: ${error.message}`, 'error');
            }
        }
        
        async function testXMLPrint(ip) {
            const useSSL = document.getElementById('useSSL').value === 'true';
            const port = useSSL ? 443 : 80;
            const protocol = useSSL ? 'HTTPS' : 'HTTP';
            
            log(`üìÑ Testar XML-utskrift till ${ip}:${port} (${protocol})...`, 'info');
            showStatus('Testar XML-utskrift...', 'info');
            
            const testXML = `<?xml version="1.0" encoding="UTF-8"?>
<s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/">
    <s:Body>
        <epos-print xmlns="http://www.epson.com/2005/02/printing/epos-print">
            <text>MOI SUSHI XML TEST</text>
            <text>==================</text>
            <text>Datum: ${new Date().toLocaleDateString('sv-SE')}</text>
            <text>Tid: ${new Date().toLocaleTimeString('sv-SE')}</text>
            <text>IP: ${ip}</text>
            <text>Port: ${port} (${protocol})</text>
            <text>==================</text>
            <text>XML Test framg√•ngsrik!</text>
            <cut type="feed"/>
        </epos-print>
    </s:Body>
</s:Envelope>`;
            
            try {
                const response = await fetch('/api/printer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'print_xml',
                        xml: testXML,
                        printerIP: ip,
                        printerPort: port,
                        useSSL: useSSL
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    log(`‚úÖ XML-utskrift framg√•ngsrik via ${protocol}!`, 'success');
                    showStatus(`XML-utskrift framg√•ngsrik (${protocol})`, 'success');
                    if (result.response) {
                        log(`üìÑ Svar: ${result.response}`, 'info');
                    }
                } else {
                    log(`‚ùå XML-utskriftsfel: ${result.error}`, 'error');
                    showStatus(`XML-utskriftsfel: ${result.error}`, 'error');
                }
            } catch (error) {
                log(`‚ùå XML-utskrift n√§tverksfel: ${error.message}`, 'error');
                showStatus(`XML-utskrift n√§tverksfel: ${error.message}`, 'error');
            }
        }
        
        async function testSSLCertificate(ip) {
            log(`üîí Testar SSL-certifikat f√∂r ${ip}...`, 'info');
            showStatus('Testar SSL-certifikat...', 'info');
            
            try {
                // Test HTTPS connection directly
                const response = await fetch(`https://${ip}:443/`, {
                    method: 'HEAD',
                    signal: AbortSignal.timeout(10000)
                });
                
                log(`‚úÖ SSL-certifikat giltigt (Status: ${response.status})`, 'success');
                showStatus(`SSL-certifikat giltigt (Status: ${response.status})`, 'success');
            } catch (error) {
                if (error.name === 'AbortError') {
                    log(`‚ùå SSL-certifikat timeout - skrivaren svarar inte p√• port 443`, 'error');
                    showStatus('SSL-certifikat timeout', 'error');
                } else if (error.message.includes('net::ERR_SSL_')) {
                    log(`‚ùå SSL-certifikat fel: ${error.message}`, 'error');
                    showStatus(`SSL-certifikat fel: ${error.message}`, 'error');
                } else {
                    log(`‚ùå SSL-certifikat ov√§ntat fel: ${error.message}`, 'error');
                    showStatus(`SSL-certifikat ov√§ntat fel: ${error.message}`, 'error');
                }
            }
        }
        
        async function discoverPrinters() {
            const discoverBtn = document.getElementById('discoverBtn');
            
            discoverBtn.disabled = true;
            discoverBtn.textContent = 'S√∂ker...';
            
            log('üîç S√∂ker efter skrivare p√• n√§tverket...', 'info');
            showStatus('S√∂ker efter skrivare...', 'info');
            
            try {
                // Test common IP ranges
                const baseIP = '192.168.1.'; // You might want to make this configurable
                const promises = [];
                
                for (let i = 1; i <= 254; i++) {
                    const ip = baseIP + i;
                    promises.push(quickTest(ip));
                }
                
                const results = await Promise.allSettled(promises);
                const foundPrinters = results
                    .map((result, index) => ({ ip: baseIP + (index + 1), result }))
                    .filter(({ result }) => result.status === 'fulfilled' && result.value)
                    .map(({ ip }) => ip);
                
                if (foundPrinters.length > 0) {
                    log(`‚úÖ Hittade ${foundPrinters.length} m√∂jliga skrivare:`, 'success');
                    foundPrinters.forEach(ip => {
                        log(`   üì° ${ip}:9100`, 'success');
                    });
                    showStatus(`Hittade ${foundPrinters.length} skrivare`, 'success');
                    
                    // Auto-fill first found printer
                    if (foundPrinters.length > 0) {
                        document.getElementById('printerIP').value = foundPrinters[0];
                        log(`üí° Fyllt i f√∂rsta hittade skrivare: ${foundPrinters[0]}`, 'info');
                    }
                } else {
                    log('‚ùå Inga skrivare hittades p√• n√§tverket', 'warning');
                    showStatus('Inga skrivare hittades', 'warning');
                }
            } catch (error) {
                log(`‚ùå Fel vid s√∂kning: ${error.message}`, 'error');
                showStatus(`S√∂kfel: ${error.message}`, 'error');
            } finally {
                discoverBtn.disabled = false;
                discoverBtn.textContent = 'S√∂k skrivare';
            }
        }
        
        async function quickTest(ip) {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 2000); // 2 second timeout
                
                const response = await fetch('/api/printer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'test',
                        printerIP: ip,
                        printerPort: 9100
                    }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                const result = await response.json();
                return result.success;
            } catch (error) {
                return false;
            }
        }
        
        // Auto-load status
        window.addEventListener('load', () => {
            log('üöÄ Epson TM-T20III Test redo', 'success');
            log('üí° Ange skrivarens IP-adress och v√§lj testmetod', 'info');
            log('üîç Anv√§nd "S√∂k skrivare" f√∂r att hitta tillg√§ngliga skrivare', 'info');
        });
    </script>
</body>
</html> 