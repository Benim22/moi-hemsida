<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Epson SSL Test - Enkel Version</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .critical {
            background: #ffebee;
            border: 2px solid #f44336;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, button {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        input {
            width: 300px;
        }
        button {
            background-color: #007cba;
            color: white;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #005a87;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .warning { background-color: #fff3cd; color: #856404; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .test-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .test-item {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #f8f9fa;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîí Epson SSL Test - Enkel Version</h1>
        
        <div class="critical">
            <h3>‚ùó VIKTIG INFORMATION</h3>
            <p><strong>Problem:</strong> Du f√•r "success" men skrivaren fungerar inte p√• riktigt.</p>
            <p><strong>Orsak:</strong> HTTPS-milj√∂ (moisushi.se) kr√§ver SSL-certifikat p√• skrivaren.</p>
            <p><strong>L√∂sning:</strong> Skrivaren m√•ste anv√§nda port 443 med SSL-certifikat.</p>
        </div>
        
        <div class="form-group">
            <label for="printerIP">Skrivare IP-adress:</label>
            <input type="text" id="printerIP" value="192.168.1.103" placeholder="t.ex. 192.168.1.103">
        </div>
        
        <div class="test-grid">
            <div class="test-item">
                <h3>üîç 1. Grundl√§ggande Test</h3>
                <button onclick="testBasicConnection()">Testa Grundanslutning</button>
                <div id="basicStatus"></div>
            </div>
            
            <div class="test-item">
                <h3>üîí 2. SSL Test</h3>
                <button onclick="testSSL()">Testa SSL (Port 443)</button>
                <div id="sslStatus"></div>
            </div>
            
            <div class="test-item">
                <h3>üåê 3. HTTP Test</h3>
                <button onclick="testHTTP()">Testa HTTP (Port 80)</button>
                <div id="httpStatus"></div>
            </div>
            
            <div class="test-item">
                <h3>‚ö° 4. Backend API Test</h3>
                <button onclick="testBackend()">Testa Backend API</button>
                <div id="backendStatus"></div>
            </div>
            
            <div class="test-item">
                <h3>üñ®Ô∏è 5. ePOS SDK Test</h3>
                <button onclick="testEPOS()">Testa ePOS SDK</button>
                <div id="eposStatus"></div>
            </div>
            
            <div class="test-item">
                <h3>üìÑ 6. XML Print Test</h3>
                <button onclick="testXMLPrint()">Testa XML Print</button>
                <div id="xmlStatus"></div>
            </div>
        </div>
        
        <div style="margin-top: 20px;">
            <button onclick="runAllTests()" style="background-color: #28a745; font-size: 16px; padding: 15px 30px;">
                üöÄ K√∂r Alla Tester
            </button>
            <button onclick="clearLog()">Rensa Logg</button>
        </div>
        
        <div id="log" class="log" style="margin-top: 20px;"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('sv-SE');
            const logElement = document.getElementById('log');
            const colorMap = {
                'info': '#333',
                'success': '#28a745',
                'error': '#dc3545',
                'warning': '#ffc107'
            };
            
            const icon = type === 'success' ? '‚úÖ' : 
                        type === 'error' ? '‚ùå' : 
                        type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            
            logElement.innerHTML += `<div style="color: ${colorMap[type]}">[${timestamp}] ${icon} ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(`[${timestamp}] ${message}`);
        }
        
        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            const statusClass = type === 'success' ? 'success' : 
                              type === 'error' ? 'error' : 
                              type === 'warning' ? 'warning' : 'info';
            
            element.innerHTML = `<div class="status ${statusClass}">${message}</div>`;
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
            // Clear all status displays
            ['basicStatus', 'sslStatus', 'httpStatus', 'backendStatus', 'eposStatus', 'xmlStatus'].forEach(id => {
                document.getElementById(id).innerHTML = '';
            });
        }
        
        // 1. Basic Connection Test
        async function testBasicConnection() {
            const ip = document.getElementById('printerIP').value;
            log(`üîç Testar grundl√§ggande anslutning till ${ip}...`, 'info');
            
            try {
                const startTime = performance.now();
                const response = await fetch(`https://${ip}/`, {
                    method: 'HEAD',
                    mode: 'no-cors',
                    signal: AbortSignal.timeout(5000)
                });
                
                const endTime = performance.now();
                const latency = Math.round(endTime - startTime);
                
                log(`‚úÖ Grundl√§ggande anslutning OK (${latency}ms)`, 'success');
                showStatus('basicStatus', `Anslutning OK (${latency}ms)`, 'success');
            } catch (error) {
                log(`‚ùå Grundl√§ggande anslutning misslyckades: ${error.message}`, 'error');
                showStatus('basicStatus', `Misslyckades: ${error.message}`, 'error');
            }
        }
        
        // 2. SSL Test
        async function testSSL() {
            const ip = document.getElementById('printerIP').value;
            log(`üîí Testar SSL-anslutning till ${ip}:443...`, 'info');
            
            try {
                const response = await fetch(`https://${ip}:443/`, {
                    method: 'GET',
                    signal: AbortSignal.timeout(10000)
                });
                
                log(`‚úÖ SSL-anslutning framg√•ngsrik (Status: ${response.status})`, 'success');
                showStatus('sslStatus', `SSL OK (Status: ${response.status})`, 'success');
            } catch (error) {
                if (error.name === 'AbortError') {
                    log(`‚ùå SSL-anslutning timeout`, 'error');
                    showStatus('sslStatus', 'SSL Timeout', 'error');
                } else {
                    log(`‚ùå SSL-anslutning misslyckades: ${error.message}`, 'error');
                    showStatus('sslStatus', `SSL Misslyckades: ${error.message}`, 'error');
                }
            }
        }
        
        // 3. HTTP Test
        async function testHTTP() {
            const ip = document.getElementById('printerIP').value;
            log(`üåê Testar HTTP-anslutning till ${ip}:80...`, 'info');
            
            // Note: This will likely fail in HTTPS environment due to Mixed Content
            if (window.location.protocol === 'https:') {
                log(`‚ö†Ô∏è HTTP-test blockeras i HTTPS-milj√∂ (Mixed Content)`, 'warning');
                showStatus('httpStatus', 'Blockerad i HTTPS', 'warning');
                return;
            }
            
            try {
                const response = await fetch(`http://${ip}:80/`, {
                    method: 'GET',
                    signal: AbortSignal.timeout(5000)
                });
                
                log(`‚úÖ HTTP-anslutning framg√•ngsrik (Status: ${response.status})`, 'success');
                showStatus('httpStatus', `HTTP OK (Status: ${response.status})`, 'success');
            } catch (error) {
                log(`‚ùå HTTP-anslutning misslyckades: ${error.message}`, 'error');
                showStatus('httpStatus', `HTTP Misslyckades: ${error.message}`, 'error');
            }
        }
        
        // 4. Backend API Test
        async function testBackend() {
            const ip = document.getElementById('printerIP').value;
            log(`‚ö° Testar backend API...`, 'info');
            
            try {
                const response = await fetch('/api/printer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'test',
                        printerIP: ip,
                        printerPort: 443,
                        useSSL: true
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    log(`‚úÖ Backend API test framg√•ngsrik`, 'success');
                    showStatus('backendStatus', 'Backend API OK', 'success');
                } else {
                    log(`‚ùå Backend API test misslyckades: ${result.error}`, 'error');
                    showStatus('backendStatus', `Backend Misslyckades: ${result.error}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Backend API fel: ${error.message}`, 'error');
                showStatus('backendStatus', `Backend Fel: ${error.message}`, 'error');
            }
        }
        
        // 5. ePOS SDK Test
        async function testEPOS() {
            const ip = document.getElementById('printerIP').value;
            log(`üñ®Ô∏è Testar ePOS SDK...`, 'info');
            
            try {
                // Try to load ePOS SDK dynamically
                if (typeof epos === 'undefined') {
                    log(`‚ö†Ô∏è ePOS SDK inte laddat, f√∂rs√∂ker ladda...`, 'warning');
                    
                    // Try to load from printer
                    const script = document.createElement('script');
                    script.src = `https://${ip}/js/epos-print-4.0.0.js`;
                    script.onload = () => {
                        log(`‚úÖ ePOS SDK laddat fr√•n skrivaren`, 'success');
                        testEPOSConnection();
                    };
                    script.onerror = () => {
                        log(`‚ùå Kunde inte ladda ePOS SDK fr√•n skrivaren`, 'error');
                        showStatus('eposStatus', 'ePOS SDK inte tillg√§ngligt', 'error');
                    };
                    document.head.appendChild(script);
                } else {
                    testEPOSConnection();
                }
            } catch (error) {
                log(`‚ùå ePOS SDK fel: ${error.message}`, 'error');
                showStatus('eposStatus', `ePOS SDK Fel: ${error.message}`, 'error');
            }
        }
        
        function testEPOSConnection() {
            const ip = document.getElementById('printerIP').value;
            
            try {
                const eposDevice = new epos.ePOSDevice();
                const url = `https://${ip}:443/`;
                
                eposDevice.connect(url, (data) => {
                    if (data === 'OK') {
                        log(`‚úÖ ePOS SDK anslutning framg√•ngsrik`, 'success');
                        showStatus('eposStatus', 'ePOS SDK OK', 'success');
                    } else {
                        log(`‚ùå ePOS SDK anslutning misslyckades: ${data}`, 'error');
                        showStatus('eposStatus', `ePOS SDK Misslyckades: ${data}`, 'error');
                    }
                });
            } catch (error) {
                log(`‚ùå ePOS SDK anslutningsfel: ${error.message}`, 'error');
                showStatus('eposStatus', `ePOS SDK Anslutningsfel: ${error.message}`, 'error');
            }
        }
        
        // 6. XML Print Test
        async function testXMLPrint() {
            const ip = document.getElementById('printerIP').value;
            log(`üìÑ Testar XML-utskrift...`, 'info');
            
            const testXML = `<?xml version="1.0" encoding="UTF-8"?>
<s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/">
    <s:Body>
        <epos-print xmlns="http://www.epson.com/2005/02/printing/epos-print">
            <text>MOI SUSHI SSL TEST</text>
            <text>==================</text>
            <text>Datum: ${new Date().toLocaleDateString('sv-SE')}</text>
            <text>Tid: ${new Date().toLocaleTimeString('sv-SE')}</text>
            <text>IP: ${ip}</text>
            <text>Port: 443 (SSL)</text>
            <text>==================</text>
            <text>SSL Test framg√•ngsrik!</text>
            <cut type="feed"/>
        </epos-print>
    </s:Body>
</s:Envelope>`;
            
            try {
                const response = await fetch(`https://${ip}:443/cgi-bin/epos/service.cgi`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/xml; charset=utf-8',
                        'SOAPAction': ''
                    },
                    body: testXML,
                    signal: AbortSignal.timeout(10000)
                });
                
                const result = await response.text();
                
                if (response.ok && !result.includes('SchemaError')) {
                    log(`‚úÖ XML-utskrift framg√•ngsrik`, 'success');
                    showStatus('xmlStatus', 'XML Print OK', 'success');
                } else {
                    log(`‚ùå XML-utskrift misslyckades: ${result}`, 'error');
                    showStatus('xmlStatus', `XML Print Misslyckades: ${result}`, 'error');
                }
            } catch (error) {
                log(`‚ùå XML-utskrift fel: ${error.message}`, 'error');
                showStatus('xmlStatus', `XML Print Fel: ${error.message}`, 'error');
            }
        }
        
        // Run all tests
        async function runAllTests() {
            log(`üöÄ Startar alla tester...`, 'info');
            
            await testBasicConnection();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testSSL();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testHTTP();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testBackend();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testEPOS();
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            await testXMLPrint();
            
            log(`‚úÖ Alla tester kompletta!`, 'success');
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            log(`üîí SSL Test initialiserad`, 'info');
            log(`üåç Nuvarande milj√∂: ${window.location.protocol}//${window.location.hostname}`, 'info');
            
            if (window.location.protocol === 'https:') {
                log(`‚úÖ HTTPS-milj√∂ detekterad - SSL-test kommer att fungera`, 'success');
            } else {
                log(`‚ö†Ô∏è HTTP-milj√∂ detekterad - vissa tester kan misslyckas`, 'warning');
            }
        });
    </script>
</body>
</html> 